#name: CI/CD Autopark
#
#on:
#  push:
#    branches: ["develop"]   # поменяй на "main", если нужно
#
#permissions:
#  contents: read
#  packages: write
#
#concurrency:
#  group: deploy-${{ github.ref }}
#  cancel-in-progress: true
#
#jobs:
#  ci:
#    name: Build & Test
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: "17"
#
#      - name: Cache Maven
#        uses: actions/cache@v4
#        with:
#          path: ~/.m2/repository
#          key: m2-${{ hashFiles('**/pom.xml') }}
#          restore-keys: |
#            m2-
#
#      - name: Maven Test
#        run: mvn -B -U -DskipTests package
#
#  docker:
#    name: Build & Push Image
#    needs: ci
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      # Приводим OWNER к нижнему регистру для GHCR и кладём IMAGE_NAME в $GITHUB_ENV
#      - name: Compute IMAGE_NAME (lowercase)
#        shell: bash
#        run: |
#          OWNER_LC=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
#          echo "IMAGE_NAME=ghcr.io/${OWNER_LC}/autopark" >> "$GITHUB_ENV"
#
#      - uses: docker/setup-buildx-action@v3
#
#      - name: Extract metadata (tags/labels)
#        id: meta
#        uses: docker/metadata-action@v5
#        with:
#          images: ${{ env.IMAGE_NAME }}
#          tags: |
#            type=raw,value=latest
#            type=sha
#
#      - name: Login to GHCR
#        uses: docker/login-action@v3
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Build and Push
#        uses: docker/build-push-action@v6
#        with:
#          context: .
#          file: ./Dockerfile
#          push: true
#          tags: ${{ steps.meta.outputs.tags }}
#          labels: ${{ steps.meta.outputs.labels }}
#
#  deploy:
#    name: Deploy to VPS
#    needs: docker
#    runs-on: ubuntu-latest
#    steps:
#      - name: Deploy over SSH
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          host: ${{ secrets.VPS_HOST }}
#          username: ${{ secrets.VPS_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}   # если секрет называется иначе — поправь
#          script: |
#            set -e
#            sudo mkdir -p /opt/autopark
#            cd /opt/autopark
#            docker compose pull
#            docker compose up -d
#            docker image prune -f
name: CI/CD Autopark

on:
  push:
    branches: ["develop"]   # при желании поменяешь на main

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Build (no tests yet)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            m2-

      - name: Maven package (skip tests for now)
        run: mvn -B -U -DskipTests package

  docker:
    name: Build & Push Docker Images
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute OWNER_LC
        shell: bash
        run: |
          OWNER_LC=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LC=$OWNER_LC" >> "$GITHUB_ENV"

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ---------- autopark-app ----------
      - name: Metadata for autopark-app
        id: meta_app
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.OWNER_LC }}/autopark-app
          tags: |
            type=raw,value=latest
            type=sha

      - name: Build & push autopark-app
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile              # root Dockerfile
          push: true
          tags: ${{ steps.meta_app.outputs.tags }}
          labels: ${{ steps.meta_app.outputs.labels }}

      # ---------- notify-service ----------
      - name: Metadata for notify-service
        id: meta_notify
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.OWNER_LC }}/notify-service
          tags: |
            type=raw,value=latest
            type=sha

      - name: Build & push notify-service
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.notify       # второй Dockerfile
          push: true
          tags: ${{ steps.meta_notify.outputs.tags }}
          labels: ${{ steps.meta_notify.outputs.labels }}

  deploy:
    name: Deploy to VPS
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            sudo mkdir -p /opt/autopark
            cd /opt/autopark
            # предполагаем, что docker-compose.yml уже лежит тут (ты залил его вручную или через git)
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
